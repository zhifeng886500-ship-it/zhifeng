import React, { useState, useEffect } from 'react';
import { Gift, Trophy, RefreshCw, User, Cpu, AlertCircle } from 'lucide-react';

// --- å¡ç‰Œèˆ‡éŠæˆ²å¸¸æ•¸èˆ‡è¨­å®š ---

const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

// æ¨¡æ“¬çš„ã€Œå‰›å‰›ç”Ÿç”¢çš„è–èª•ç¯€æŠ½çç¦®ç‰©ã€æ¸…å–®
const CHRISTMAS_PRIZES = [
  { name: "iPhone 15 Pro", icon: "ğŸ“±", rarity: "SSR" },
  { name: "PlayStation 5", icon: "ğŸ®", rarity: "SSR" },
  { name: "é«˜ç´šç™¾è²¨ç¦®åˆ¸ $5000", icon: "ğŸ«", rarity: "SR" },
  { name: "é™å™ªè—èŠ½è€³æ©Ÿ", icon: "ğŸ§", rarity: "SR" },
  { name: "è–èª•é™å®šé¦™æ°›è Ÿç‡­", icon: "ğŸ•¯ï¸", rarity: "R" },
  { name: "ç²¾ç¾ä¿æº«æ¯", icon: "ğŸ¥¤", rarity: "R" },
  { name: "æ‰‹å·¥è–‘é¤…äººé¤…ä¹¾", icon: "ğŸª", rarity: "N" },
  { name: "è–èª•è€å…¬å…¬çš„æ“æŠ± (ç©ºæ°£)", icon: "ğŸ…", rarity: "N" },
];

// --- è¼”åŠ©å‡½å¼ ---

// ç”¢ç”Ÿä¸€å‰¯ç‰Œï¼ˆ52å¼µ + 1å¼µé¬¼ç‰Œï¼‰
const generateDeck = () => {
  let deck = [];
  SUITS.forEach(suit => {
    VALUES.forEach(value => {
      deck.push({
        id: `${suit}-${value}`,
        suit,
        value,
        isJoker: false,
        color: (suit === 'â™¥' || suit === 'â™¦') ? 'red' : 'black'
      });
    });
  });
  // åŠ å…¥é¬¼ç‰Œ
  deck.push({ id: 'JOKER', suit: '', value: 'JOKER', isJoker: true, color: 'purple' });
  return deck.sort(() => Math.random() - 0.5); // æ´—ç‰Œ
};

// ç§»é™¤æˆå°çš„ç‰Œ
const removePairs = (hand) => {
  const newHand = [...hand];
  const pairsRemoved = [];
  let hasPairs = true;

  while (hasPairs) {
    hasPairs = false;
    const valueMap = {};
    
    // ç´€éŒ„æ¯ç¨®æ•¸å­—çš„ä½ç½®
    newHand.forEach((card, index) => {
      if (card.isJoker) return;
      if (!valueMap[card.value]) valueMap[card.value] = [];
      valueMap[card.value].push(index);
    });

    // å°‹æ‰¾å°å­ä¸¦ç§»é™¤
    for (const value in valueMap) {
      if (valueMap[value].length >= 2) {
        // ç§»é™¤æœ€å¾Œå…©å¼µåŒé»æ•¸çš„ç‰Œ
        const idx1 = valueMap[value].pop();
        const idx2 = valueMap[value].pop();
        // å› ç‚ºè¦å¾é™£åˆ—ç§»é™¤ï¼Œå…ˆç§»é™¤ index å¤§çš„ï¼Œé¿å…å½±éŸ¿ index å°çš„
        if (idx1 > idx2) {
            newHand.splice(idx1, 1);
            newHand.splice(idx2, 1);
        } else {
            newHand.splice(idx2, 1);
            newHand.splice(idx1, 1);
        }
        hasPairs = true; // æ¨™è¨˜æœ‰è®Šå‹•ï¼Œé‡æ–°æª¢æŸ¥
        break; // ç‚ºäº†å®‰å…¨èµ·è¦‹ï¼Œä¸€æ¬¡è¿´åœˆåªç§»é™¤ä¸€å°ï¼Œç„¶å¾Œé‡æ–°æƒæ
      }
    }
  }
  return newHand;
};

// --- ä¸»å…ƒä»¶ ---

export default function ChristmasOldMaidGame() {
  const [gameState, setGameState] = useState('start'); // start, playing, result, prize
  const [playerHand, setPlayerHand] = useState([]);
  const [cpuHand, setCpuHand] = useState([]);
  const [turn, setTurn] = useState('player'); // player, cpu
  const [statusMessage, setStatusMessage] = useState('æ­¡è¿ä¾†åˆ°è–èª•æŠ½é¬¼ç‰Œï¼');
  const [drawnPrize, setDrawnPrize] = useState(null);
  const [winner, setWinner] = useState(null);
  
  // å‹•ç•«ç›¸é—œç‹€æ…‹
  const [isDealing, setIsDealing] = useState(false);
  const [selectedCardIndex, setSelectedCardIndex] = useState(null);

  // åˆå§‹åŒ–éŠæˆ²
  const startGame = () => {
    setIsDealing(true);
    setStatusMessage('ç™¼ç‰Œä¸­...');
    setGameState('playing');
    setWinner(null);
    setDrawnPrize(null);

    setTimeout(() => {
      const deck = generateDeck();
      // ç™¼ç‰Œ
      const pHand = [];
      const cHand = [];
      deck.forEach((card, i) => {
        if (i % 2 === 0) pHand.push(card);
        else cHand.push(card);
      });

      // ç§»é™¤åˆå§‹å°å­
      const cleanPHand = removePairs(pHand);
      const cleanCHand = removePairs(cHand);

      setPlayerHand(cleanPHand);
      setCpuHand(cleanCHand);
      setTurn('player');
      setIsDealing(false);
      setStatusMessage('ä½ çš„å›åˆï¼è«‹é»é¸ä¸€å¼µé›»è…¦çš„ç‰Œã€‚');
    }, 1000);
  };

  // æª¢æŸ¥å‹åˆ©æ¢ä»¶
  useEffect(() => {
    if (gameState !== 'playing' || isDealing) return;

    if (playerHand.length === 0) {
      endGame('player');
    } else if (cpuHand.length === 0) {
      endGame('cpu');
    }
  }, [playerHand, cpuHand, gameState, isDealing]);

  const endGame = (whoWon) => {
    setWinner(whoWon);
    setGameState('result');
    if (whoWon === 'player') {
      setStatusMessage('æ­å–œä½ è´äº†ï¼ç²å¾—è–èª•æŠ½çè³‡æ ¼ï¼');
    } else {
      setStatusMessage('é›»è…¦è´äº†ï¼Œé¬¼ç‰Œåœ¨ä½ æ‰‹ä¸Š... è–èª•ç¦®ç‰©æ²’äº† Q_Q');
    }
  };

  // é›»è…¦å›åˆé‚è¼¯
  useEffect(() => {
    if (turn === 'cpu' && gameState === 'playing' && !isDealing && winner === null) {
      setStatusMessage('é›»è…¦æ€è€ƒä¸­...');
      const timer = setTimeout(() => {
        cpuPlay();
      }, 1500);
      return () => clearTimeout(timer);
    }
  }, [turn, gameState, isDealing, winner]);

  // ç©å®¶æŠ½ç‰Œé‚è¼¯
  const handleDrawCard = (cardIndex) => {
    if (turn !== 'player' || gameState !== 'playing') return;
    
    // 1. å¾é›»è…¦æ‰‹ä¸­ç§»é™¤ç‰Œ
    const chosenCard = cpuHand[cardIndex];
    const newCpuHand = cpuHand.filter((_, i) => i !== cardIndex);
    
    // 2. åŠ å…¥ç©å®¶æ‰‹ç‰Œ
    const newPlayerHand = [...playerHand, chosenCard];
    
    // 3. æ•´ç†å°å­
    const cleanPlayerHand = removePairs(newPlayerHand);

    setCpuHand(newCpuHand);
    setPlayerHand(cleanPlayerHand);
    
    // é¡¯ç¤ºè¨Šæ¯
    let msg = `ä½ æŠ½åˆ°äº† ${chosenCard.isJoker ? 'é¬¼ç‰Œ ğŸƒ' : chosenCard.suit + chosenCard.value}`;
    if (cleanPlayerHand.length < newPlayerHand.length) {
      msg += 'ï¼Œä¸¦æ¹Šæˆäº†ä¸€å°ä¸Ÿæ£„ï¼';
    }
    setStatusMessage(msg);

    setTurn('cpu');
  };

  // é›»è…¦æŠ½ç‰Œé‚è¼¯
  const cpuPlay = () => {
    if (playerHand.length === 0) return;

    // éš¨æ©Ÿé¸ä¸€å¼µç©å®¶çš„ç‰Œ
    const randomIndex = Math.floor(Math.random() * playerHand.length);
    const chosenCard = playerHand[randomIndex];
    
    // 1. å¾ç©å®¶æ‰‹ä¸­ç§»é™¤
    const newPlayerHand = playerHand.filter((_, i) => i !== randomIndex);

    // 2. åŠ å…¥é›»è…¦æ‰‹ç‰Œ
    const newCpuHand = [...cpuHand, chosenCard];

    // 3. æ•´ç†å°å­
    const cleanCpuHand = removePairs(newCpuHand);

    setPlayerHand(newPlayerHand);
    setCpuHand(cleanCpuHand);

    let msg = 'é›»è…¦æŠ½èµ°äº†ä½ ä¸€å¼µç‰Œ';
    if (cleanCpuHand.length < newCpuHand.length) {
      msg += 'ï¼Œä¸¦æ¹Šæˆäº†ä¸€å°ä¸Ÿæ£„ã€‚';
    } else {
      msg += 'ã€‚';
    }
    
    setStatusMessage(msg + ' è¼ªåˆ°ä½ äº†ï¼');
    setTurn('player');
  };

  // æŠ½çé‚è¼¯
  const handleLuckyDraw = () => {
    setStatusMessage('æŠ½çç®±æ–æ™ƒä¸­...');
    setGameState('prize');
    
    // ç°¡å–®çš„å‹•ç•«å»¶é²
    setTimeout(() => {
      const randomPrize = CHRISTMAS_PRIZES[Math.floor(Math.random() * CHRISTMAS_PRIZES.length)];
      setDrawnPrize(randomPrize);
      setStatusMessage(`æ­å–œç²å¾—ï¼š${randomPrize.name}ï¼`);
    }, 2000);
  };

  // --- UI å…ƒä»¶ ---

  // å¡ç‰ŒèƒŒé¢å…ƒä»¶
  const CardBack = ({ onClick, disabled }) => (
    <div 
      onClick={!disabled ? onClick : undefined}
      className={`
        w-16 h-24 md:w-20 md:h-28 bg-gradient-to-br from-red-600 to-red-800 
        rounded-lg border-2 border-white shadow-md flex items-center justify-center
        transform transition-transform duration-200 
        ${!disabled ? 'hover:-translate-y-2 cursor-pointer hover:shadow-xl' : ''}
      `}
    >
      <div className="text-white text-2xl opacity-50">ğŸ„</div>
    </div>
  );

  // å¡ç‰Œæ­£é¢å…ƒä»¶
  const CardFront = ({ card }) => (
    <div className={`
      w-16 h-24 md:w-20 md:h-28 bg-white rounded-lg border border-gray-300 shadow-md 
      flex flex-col items-center justify-center select-none relative
      ${card.isJoker ? 'bg-purple-50' : ''}
    `}>
      <div className={`text-lg font-bold ${card.color === 'red' ? 'text-red-600' : 'text-black'}`}>
        {card.value}
      </div>
      <div className={`text-2xl ${card.color === 'red' ? 'text-red-600' : 'text-black'}`}>
        {card.isJoker ? 'ğŸ¤¡' : card.suit}
      </div>
      {card.isJoker && <span className="text-xs text-purple-600 font-bold mt-1">JOKER</span>}
    </div>
  );

  return (
    <div className="min-h-screen bg-green-800 font-sans text-gray-100 flex flex-col items-center p-4">
      {/* æ¨™é¡Œå€ */}
      <header className="mb-6 text-center">
        <h1 className="text-3xl md:text-4xl font-bold text-yellow-400 drop-shadow-md mb-2">
          ğŸ… è–èª•æŠ½é¬¼ç‰Œå¤§æˆ° ğŸƒ
        </h1>
        <div className="bg-white/20 px-4 py-2 rounded-full text-sm md:text-base backdrop-blur-sm border border-white/30">
          {statusMessage}
        </div>
      </header>

      {/* éŠæˆ²å€åŸŸ */}
      {gameState === 'start' && (
        <div className="flex flex-col items-center justify-center flex-1 space-y-8 animate-fade-in">
          <div className="text-6xl animate-bounce">ğŸ</div>
          <button 
            onClick={startGame}
            className="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow-lg transition-all transform hover:scale-105 active:scale-95 flex items-center gap-2"
          >
            <RefreshCw size={20} />
            é–‹å§‹éŠæˆ²
          </button>
          <p className="text-green-200 max-w-md text-center text-sm">
            è¦å‰‡ï¼šç¶“å…¸æŠ½é¬¼ç‰Œã€‚æ‰‹ç‰Œç‡å…ˆæ¸…ç©ºè€…ç²å‹ï¼Œç²å‹è€…å¯é€²è¡Œè–èª•å¥½ç¦®æŠ½çï¼
          </p>
        </div>
      )}

      {(gameState === 'playing' || gameState === 'result') && (
        <div className="w-full max-w-4xl flex flex-col justify-between flex-1 gap-4">
          
          {/* é›»è…¦æ‰‹ç‰Œå€ (ä¸Šæ–¹) */}
          <div className="flex flex-col items-center bg-green-900/40 p-4 rounded-xl border border-green-700/50">
            <div className="flex items-center gap-2 mb-2 text-green-200">
              <Cpu size={20} />
              <span className="font-bold">é›»è…¦çš„æ‰‹ç‰Œ ({cpuHand.length} å¼µ)</span>
              {turn === 'cpu' && <span className="animate-pulse text-yellow-400 text-xs">æ€è€ƒä¸­...</span>}
            </div>
            <div className="flex flex-wrap justify-center gap-2">
              {cpuHand.map((card, index) => (
                <div key={`cpu-${index}`} className="relative -ml-6 first:ml-0 transition-all hover:z-10">
                  <CardBack 
                    onClick={() => handleDrawCard(index)}
                    disabled={turn !== 'player' || gameState !== 'playing'} 
                  />
                </div>
              ))}
            </div>
          </div>

          {/* ä¸­å¤®è¨Šæ¯/äº’å‹•å€ */}
          <div className="flex justify-center items-center py-4">
            {gameState === 'result' && winner === 'player' && (
               <button 
               onClick={handleLuckyDraw}
               className="animate-pulse px-8 py-4 bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold rounded-xl shadow-xl flex items-center gap-3"
             >
               <Gift size={28} />
               é–‹å•Ÿè–èª•æŠ½çï¼
             </button>
            )}
             {gameState === 'result' && winner === 'cpu' && (
               <button 
               onClick={startGame}
               className="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg shadow-lg flex items-center gap-2"
             >
               <RefreshCw size={20} />
               å†ç©ä¸€æ¬¡
             </button>
            )}
          </div>

          {/* ç©å®¶æ‰‹ç‰Œå€ (ä¸‹æ–¹) */}
          <div className="flex flex-col items-center bg-green-900/40 p-4 rounded-xl border border-green-700/50">
             <div className="flex items-center gap-2 mb-2 text-green-200">
              <User size={20} />
              <span className="font-bold">ä½ çš„æ‰‹ç‰Œ ({playerHand.length} å¼µ)</span>
              {turn === 'player' && <span className="text-yellow-400 text-xs">è«‹é»é¸ä¸Šæ–¹é›»è…¦çš„ç‰Œ</span>}
            </div>
            <div className="flex flex-wrap justify-center gap-2">
              {playerHand.map((card, index) => (
                <div key={card.id} className="relative -ml-4 first:ml-0 hover:-translate-y-4 transition-transform duration-200 hover:z-10">
                  <CardFront card={card} />
                </div>
              ))}
            </div>
          </div>

        </div>
      )}

      {/* æŠ½ççµæœç•«é¢ */}
      {gameState === 'prize' && (
        <div className="flex flex-col items-center justify-center flex-1 animate-fade-in text-center">
          {!drawnPrize ? (
            <div className="text-6xl animate-spin mb-4">ğŸ</div>
          ) : (
            <div className="bg-white/10 backdrop-blur-md p-8 rounded-2xl border-2 border-yellow-400 shadow-2xl flex flex-col items-center transform transition-all scale-100">
              <div className="text-yellow-300 text-xl font-bold mb-4">MERRY CHRISTMAS</div>
              <div className="text-8xl mb-4 animate-bounce">{drawnPrize.icon}</div>
              <h2 className="text-3xl font-bold text-white mb-2">{drawnPrize.name}</h2>
              <span className={`px-3 py-1 rounded-full text-xs font-bold 
                ${drawnPrize.rarity === 'SSR' ? 'bg-yellow-500 text-black' : 
                  drawnPrize.rarity === 'SR' ? 'bg-purple-500 text-white' : 'bg-blue-500 text-white'}`}>
                {drawnPrize.rarity} è³
              </span>
              
              <div className="mt-8 flex gap-4">
                 <button 
                  onClick={startGame}
                  className="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-bold"
                >
                  å†ä¾†ä¸€å±€
                </button>
              </div>
            </div>
          )}
        </div>
      )}
      
      {/* é å°¾ */}
      <footer className="mt-6 text-green-400 text-xs">
        Design for Christmas Event 2025
      </footer>

      {/* ç°¡å–®çš„ CSS å‹•ç•«å®šç¾© */}
      <style>{`
        @keyframes fade-in {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
}
